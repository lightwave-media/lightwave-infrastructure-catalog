name: Infrastructure Testing Framework

on:
  pull_request:
    branches: [main, dev]
    paths:
      - 'modules/**'
      - 'units/**'
      - 'test/**'
      - '.github/workflows/infrastructure-tests.yml'
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - modules
          - core-modules
          - full

env:
  AWS_REGION: us-east-1
  GO_VERSION: '1.24'
  OPENTOFU_VERSION: '1.8.8'
  TERRAGRUNT_VERSION: '0.82.3'

jobs:
  # Job 1: Pre-flight checks (fast, runs on every PR)
  pre-flight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks
        run: pre-commit run --all-files

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Go fmt check
        working-directory: test
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -d .
            exit 1
          fi

      - name: Go vet
        working-directory: test
        run: go vet ./...

  # Job 2: Module validation (fast, no deployment)
  validate-modules:
    name: Validate Modules (No Deploy)
    runs-on: ubuntu-latest
    needs: pre-flight
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('test/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download Go dependencies
        working-directory: test
        run: |
          go mod download
          go mod tidy

      - name: Run module validation tests
        working-directory: test
        run: make ci-test-modules-minimal
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION }}

  # Job 3: ECS Module Tests (deploys infrastructure)
  test-ecs-module:
    name: Test ECS Fargate Module
    runs-on: ubuntu-latest
    needs: validate-modules
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'test:deploy'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('test/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download Go dependencies
        working-directory: test
        run: go mod download

      - name: Run ECS module tests
        working-directory: test
        run: make ci-test-ecs-module
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION }}

  # Job 4: PostgreSQL Module Tests (deploys infrastructure, slow)
  test-postgresql-module:
    name: Test PostgreSQL RDS Module
    runs-on: ubuntu-latest
    needs: validate-modules
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'test:deploy'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('test/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download Go dependencies
        working-directory: test
        run: go mod download

      - name: Run PostgreSQL module tests
        working-directory: test
        run: make ci-test-postgresql-module
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION }}

  # Job 5: Redis Module Tests (deploys infrastructure)
  test-redis-module:
    name: Test Redis ElastiCache Module
    runs-on: ubuntu-latest
    needs: validate-modules
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'test:deploy'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('test/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download Go dependencies
        working-directory: test
        run: go mod download

      - name: Run Redis module tests
        working-directory: test
        run: make ci-test-redis-module
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION }}

  # Job 6: Django Unit Tests (existing tests)
  test-django-unit:
    name: Test Django Fargate Unit
    runs-on: ubuntu-latest
    needs: validate-modules
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'test:deploy'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('test/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download Go dependencies
        working-directory: test
        run: go mod download

      - name: Run Django unit tests
        working-directory: test
        run: make ci-test-unit
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION }}
          AWS_PROFILE: lightwave-admin-new

  # Job 7: Test Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [pre-flight, validate-modules, test-ecs-module, test-postgresql-module, test-redis-module]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-flight Checks | ${{ needs.pre-flight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Modules | ${{ needs.validate-modules.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ECS Module Tests | ${{ needs.test-ecs-module.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PostgreSQL Module Tests | ${{ needs.test-postgresql-module.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Redis Module Tests | ${{ needs.test-redis-module.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.pre-flight.result }}" != "success" ] || \
             [ "${{ needs.validate-modules.result }}" != "success" ]; then
            echo "❌ Critical tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "✅ All critical tests passed" >> $GITHUB_STEP_SUMMARY

  # Job 8: Cost Estimation (runs after deployment tests)
  cost-estimate:
    name: Estimate Test Costs
    runs-on: ubuntu-latest
    needs: [test-ecs-module, test-postgresql-module, test-redis-module]
    if: always() && (needs.test-ecs-module.result != 'skipped' || needs.test-postgresql-module.result != 'skipped' || needs.test-redis-module.result != 'skipped')
    steps:
      - name: Calculate estimated costs
        run: |
          echo "## Infrastructure Test Costs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Estimated costs for this test run:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL_COST=0

          if [ "${{ needs.test-ecs-module.result }}" == "success" ]; then
            echo "- ECS Fargate: ~$1.00" >> $GITHUB_STEP_SUMMARY
            TOTAL_COST=$((TOTAL_COST + 1))
          fi

          if [ "${{ needs.test-postgresql-module.result }}" == "success" ]; then
            echo "- PostgreSQL RDS: ~$2.00" >> $GITHUB_STEP_SUMMARY
            TOTAL_COST=$((TOTAL_COST + 2))
          fi

          if [ "${{ needs.test-redis-module.result }}" == "success" ]; then
            echo "- Redis ElastiCache: ~$1.00" >> $GITHUB_STEP_SUMMARY
            TOTAL_COST=$((TOTAL_COST + 1))
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Estimated Cost: ~\$${TOTAL_COST}.00**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Note: Costs are estimates based on typical test durations. Actual costs may vary._" >> $GITHUB_STEP_SUMMARY
